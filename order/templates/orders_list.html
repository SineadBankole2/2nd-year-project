{% extends 'base.html' %}

{% block content %}
<header class="bg-dark text-white py-3">
  <div class="container text-center">
    {% include 'header.html' %}
  </div>
</header>

{% include 'nav.html' %}

<div class="container">
  {% if user.is_authenticated %}

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .card-container{display:flex;justify-content:center;align-items:flex-start;min-height:60vh;padding:2rem 0;}
      .card{width:min(92vw,62rem);padding:1.5rem;border-radius:.75rem;}
      .card-title{font-size:1.75rem;}
      .muted{color:#6c757d}
      .badge-status{font-size:.9rem}
      .list-group-item .meta{font-size:.9rem;color:#6c757d}
      .review-toggle{cursor:pointer}
      .review-form textarea{min-height:90px}
      .item-thumb{width:72px;height:72px;object-fit:cover;border-radius:.375rem;border:1px solid #eee;}
    </style>

    <div class="container-fluid card-container">
      <div class="card shadow-sm">

        {% if messages %}
          <div class="mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}

        {# ================= DETAIL VIEW ================= #}
        {% if order %}
          <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div>
              <h5 class="card-title mb-1">Order #{{ order.id }}</h5>
              <div class="muted">Placed: {{ order.created|date:"d M Y, H:i" }}</div>
            </div>
            <span class="badge badge-status
              {% if order.status == 'Paid' %}badge-success
              {% elif order.status == 'Pending' %}badge-warning
              {% elif order.status == 'Shipped' %}badge-primary
              {% elif order.status == 'Cancelled' %}badge-secondary
              {% elif order.status == 'Refunded' %}badge-info
              {% else %}badge-light{% endif %}">
              {{ order.status }}
            </span>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="mb-2">Billing</h6>
              <div>{{ order.billingName }}</div>
              <div>{{ order.billingAddress1 }}</div>
              <div>{{ order.billingCity }} {{ order.billingPostcode }}</div>
              <div>{{ order.billingCountry }}</div>
            </div>
            <div class="col-md-6 mb-3">
              <h6 class="mb-2">Shipping</h6>
              <div>{{ order.shippingName }}</div>
              <div>{{ order.shippingAddress1 }}</div>
              <div>{{ order.shippingCity }} {{ order.shippingPostcode }}</div>
              <div>{{ order.shippingCountry }}</div>
            </div>
          </div>

          <h6 class="mt-2">Items</h6>

          {# Each purchased item with review form #}
          <div class="row">
            {% for it in order_items %}
              {% with p=it.product_ref %}
              <div class="col-md-6 mb-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="d-flex">
                        {% if p and p.image %}
                          <img src="{{ p.image.url }}" alt="{{ p.name }}" class="item-thumb mr-2">
                        {% endif %}
                        <div class="mr-2">
                          <div class="font-weight-bold">
                            {{ it.product }}{# text fallback #}
                            {% if p and p.name and p.name != it.product %}<br><small class="text-muted">{{ p.name }}</small>{% endif %}
                          </div>
                          <div class="meta">Qty: {{ it.quantity }}</div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div>Price: €{{ it.price|floatformat:2 }}</div>
                        <div class="font-weight-bold">Subtotal: €{{ it.sub_total|floatformat:2 }}</div>
                      </div>
                    </div>

                    <hr>

                    {% if p %}
                      <a class="review-toggle text-primary" data-toggle="collapse" href="#rv-{{ forloop.counter }}" role="button" aria-expanded="false" aria-controls="rv-{{ forloop.counter }}">
                        Leave a review
                      </a>
                      <div class="collapse mt-2" id="rv-{{ forloop.counter }}">
                        <form class="review-form" method="post" action="{% url 'submit_review' %}">
                          {% csrf_token %}
                          <input type="hidden" name="product" value="{{ p.id }}">
                          <input type="hidden" name="next" value="{% url 'reviews' %}">
                          <div class="form-group">
                            <label for="rating-{{ forloop.counter }}">Rating</label>
                            <select id="rating-{{ forloop.counter }}" class="form-control" name="rating" required>
                              <option value="" selected disabled>Select…</option>
                              <option value="5">★★★★★ (5)</option>
                              <option value="4">★★★★☆ (4)</option>
                              <option value="3">★★★☆☆ (3)</option>
                              <option value="2">★★☆☆☆ (2)</option>
                              <option value="1">★☆☆☆☆ (1)</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="rvtxt-{{ forloop.counter }}">Your review</label>
                            <textarea id="rvtxt-{{ forloop.counter }}" class="form-control" name="review_text" placeholder="What did you think?" required></textarea>
                          </div>
                          <button class="btn btn-primary btn-sm" type="submit">Submit review</button>
                        </form>
                      </div>
                    {% else %}
                      <span class="text-muted">Review unavailable (product not found)</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endwith %}
            {% empty %}
              <div class="col-12">
                <div class="alert alert-light border">No items on this order.</div>
              </div>
            {% endfor %}
          </div>

          <div class="d-flex justify-content-between align-items-start mt-3 flex-wrap">
            <div class="mb-2">
              <div>Discount: <strong>{{ order.discount }}%</strong></div>
              <div class="h5 mb-0">Total: <strong>€{{ order.total|floatformat:2 }}</strong></div>
            </div>
            <div class="mb-2">
              <a href="{% url 'order:order_history' %}" class="btn btn-secondary mr-2">← Back to Order History</a>
              {% if order.status != 'Cancelled' %}
                <form method="post" action="{% url 'order:cancel_order' order.id %}" class="d-inline" onsubmit="return confirm('Cancel this order?');">
                  {% csrf_token %}
                  <button class="btn btn-outline-danger">Cancel Order</button>
                </form>
              {% else %}
                <span class="badge badge-secondary align-self-center">Already Cancelled</span>
              {% endif %}
            </div>
          </div>

        {# ================= LIST VIEW ================= #}
        {% else %}
          <h5 class="card-title mb-3">Your Orders</h5>

          {% if order_details %}
            <ul class="list-group mb-3">
              {% for o in order_details %}
                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                  <div>
                    <div class="font-weight-bold">#{{ o.id }} · €{{ o.total|floatformat:2 }}</div>
                    <div class="meta">Placed: {{ o.created|date:"d M Y, H:i" }}</div>
                    <span class="badge badge-status mt-1
                      {% if o.status == 'Paid' %}badge-success
                      {% elif o.status == 'Pending' %}badge-warning
                      {% elif o.status == 'Shipped' %}badge-primary
                      {% elif o.status == 'Cancelled' %}badge-secondary
                      {% elif o.status == 'Refunded' %}badge-info
                      {% else %}badge-light{% endif %}">
                      {{ o.status }}
                    </span>
                  </div>
                  <div>
                    <a href="{% url 'order:order_detail' o.id %}" class="btn btn-sm btn-primary mr-2">View</a>
                    {% if o.status != 'Cancelled' %}
                      <form method="post" action="{% url 'order:cancel_order' o.id %}" class="d-inline" onsubmit="return confirm('Cancel order #{{ o.id }}?');">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger">Cancel</button>
                      </form>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="card-text">You have not placed any orders yet.</p>
            <a href="{% url 'store:all_products' %}" class="btn btn-black">Continue shopping</a>
          {% endif %}
        {% endif %}
      </div>
    </div>

  {% else %}
    <div class="alert alert-warning my-4" role="alert">
      You need to <a href="{% url 'login' %}" class="alert-link">sign in</a> to view your orders.
    </div>
  {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock %}
